/**
 * Copyright (c) 2010-12 OrangeUI

 * Permission is hereby granted, free of charge, to any person obtaining
 * a copy of this software and associated documentation files (the
 * "Software"), to deal in the Software without restriction, including
 * without limitation the rights to use, copy, modify, merge, publish,
 * distribute, sublicense, and/or sell copies of the Software, and to
 * permit persons to whom the Software is furnished to do so, subject to
 * the following conditions:

 * The above copyright notice and this permission notice shall be
 * included in all copies or substantial portions of the Software.

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
 * EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
 * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
 * NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
 * LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
 * OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
 * WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 */

if(typeof(console)=="undefined"){console={log:function(){},dir:function(){}}}function noop(){}function clone(b){var a=(b instanceof Array)?[]:{};for(i in b){if(i=="clone"){continue}if(b[i]&&typeof b[i]=="object"){a[i]=clone(b[i])}else{a[i]=b[i]}}return a}function cloneAttributes(d,b){var b=$(b).eq(0);var d=$(d)[0];for(i=0;i<d.attributes.length;i++){var c=d.attributes[i];b.attr(c.name,c.value)}}Class=(function(){var b=false,c=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;a.extend=function(h){var g=this.prototype;b=true;var f=new this();b=false;for(var e in h){f[e]=typeof h[e]=="function"&&typeof g[e]=="function"&&c.test(h[e])?(function(j,k){return function(){var m=this._super;this._super=g[j];var l=k.apply(this,arguments);this._super=m;return l}})(e,h[e]):h[e]}function d(){if(!b&&this.initialize){this.initialize.apply(this,arguments)}}d.prototype=f;d.prototype.constructor=d;d.extend=arguments.callee;return d};a.proxy=function(e,d){var f=d;return function(){return e.apply(f,arguments)}};function a(){}return a})();EventTarget=(function(){function a(b,e,d,c){this.bubbles=true;this.type=b;this.currentTarget=e;this.target=d;this.data=c}a.prototype.stopPropagation=function(){this.bubbles=false};return a})();EventHandle=(function(){function a(d,c,b){this.target=d;this.ev=c;this.call=b}a.prototype.detach=function(){this.target.detach(this.ev,this.call);delete this.target;delete this.ev;delete this.call;delete this};return a})();Events=(function(){function a(c,b){this._listeners={};this._parent=c;this._self=b}a.prototype.on=function(c,b){if(!this._listeners.hasOwnProperty(c)){this._listeners[c]=[]}this._listeners[c].push(b);return new EventHandle(this,c,b)};a.prototype.fire=function(f,g){var e=this._parent;if(typeof f==="string"){f=new EventTarget(f,this._self,this._self,g)}if(typeof f.type!=="string"){throw"Error: Invalid 'type' when firing event"}if(this._listeners[f.type] instanceof Array){var d=this._listeners[f.type];for(var c=0,b=d.length;c<b;c++){d[c].call(this,f)}}if(e!=null&&e._eventTarget instanceof EventTarget&&f.bubbles){f.currentTarget=this._parent;e._eventTarget.fire.call(e._eventTarget,f,g)}};a.prototype.detach=function(f,e){if(this._listeners[f] instanceof Array){var d=this._listeners[f];for(var c=0,b=d.length;c<b;c++){if(typeof e!=="undefined"&&d[c]===e){d.splice(c,1);break}else{d.splice(c,1)}}}else{if(typeof f==="undefined"){this._listeners={}}}};a.prototype.destroy=function(){for(var b in this._listeners){b.detach()}delete this._parent;delete this._self};return a})();var ViewController=Class.extend({initialize:function(q,l){var j=this,r=[],d=[];this.loading=false;this.unloading=false;this.loaded=false;this.visible=false;this.appearing=false;this.disappearing=false;this.changing=false;this.loadEvts=[];this.unloadEvts=[];this.showEvts=[];this.hideEvts=[];this.views={};this.elements={};this.events=[];this.data={};this.source=l.clone();this.eventTarget=new Events(q,this);if(typeof l!=="undefined"){this.target=$(l);var f=$(l).get(0)}else{throw"Invalid target"}this.parent=(typeof q!=="undefined")?q:null;if(this.parent===null){this.target.removeAttr("data-root")}for(var h=0,k=f.attributes.length;h<k;h++){if(f.attributes[h].name.match(/data-/)){this.data[f.attributes[h].name.replace(/data-/,"")]=f.attributes[h].value}}var b=function(c){var t=[];this.target.find(c).each(function(){var u=false,v=$(this).parent();while(v.length!==0&&!u){if($(v).not($(j.target)).length===0){u=true;break}else{if($(v).not("[data-control]").length===0){u=false;break}}v=$(v).parent()}if(u){t.push(this)}});return t};r=b.call(this,"[data-control]");d=b.call(this,"[data-name]:not([data-control])");console.log(this.data.name+" Initialized");for(var h=0,k=r.length;h<k;h++){var p=$(r[h]),e=p.attr("data-name"),n=p.attr("data-control"),s=p.attr("data-template"),o=(typeof s!=="undefined"&&s.length>0);if(o){var a=View.load(s);p.html($(a).html());cloneAttributes(a,p);p.removeAttr("data-template")}var m=ViewController.get(n);this.views[e]=new m(this,p)}for(var h=0,k=d.length;h<k;h++){var g=$(d[h]),e=g.attr("data-name");if(typeof e!=="undefined"&&e.length>0){this.elements[e]=g.removeAttr("data-name").addClass(e)}}this.target.addClass(this.getClasses());this.target.removeAttr("data-control").removeAttr("data-name");this.target.addClass("hidden");this.type=this.getType();this.name=this.data.name},getType:function(){return"ui-view"},getClasses:function(){var a=typeof this.typeList!=="undefined"?this.typeList:"";return a+" "+this.data.name?this.data.name:""},getTriggers:function(){return[]},getBindings:function(){return{}},load:function(){if(this.loading||this.loaded){return}this.loading=true;this.loadEvts.push(this.on("_load",this.onLoad,this));this.loadEvts.push(this.on("_loaded",this.onDidLoad,this));this.onWillLoad()},onWillLoad:function(){this.fire("_load")},onLoad:function(){for(var a in this.views){this.views[a].load()}this.fire("_loaded")},onDidLoad:function(){for(var b=0,a=this.loadEvts.length;b<a;b++){this.loadEvts[b].detach()}this.loadEvts=[];this.loading=false;this.loaded=true;this.fire("load")},unload:function(){if(this.unloading||!this.loaded){return}if(this.visible&&!this.disappearing){this.vEvt=this.on("disappear",function(a){this.unload();this.vEvt.detach()},this);this.hide();return}this.unloadEvts.push(this.on("_unload",this.onUnload,this));this.unloadEvts.push(this.on("_unloaded",this.onDidUnload,this));this.unloading=true;this.onWillUnload()},onWillUnload:function(){this.fire("_unload")},onUnload:function(){for(var a in this.views){this.views[a].unload()}this.target.remove();this.fire("_unloaded")},onDidUnload:function(){for(var b=0,a=this.unloadEvts.length;b<a;b++){this.unloadEvts[b].detach()}this.unloadEvts=[];this.unloading=false;this.loaded=false;this.fire("unload")},show:function(){if(this.visible||this.appearing){return}this.appearing=true;this.showEvts.push(this.on("_appear",this.onAppear,this));this.showEvts.push(this.on("_appeared",this.onDidAppear,this));this.onWillAppear()},onWillAppear:function(){var b=this.getBindings();for(var a in b){var d=b[a];for(var f in d){var e=(typeof d[f]==="function")?d[f]:null;if(f=="touchclick"){f=Browser.isTouch?"touchend":"click"}if(e===null){var c=f.charAt(0).toUpperCase()+f.slice(1);e=(d[f]===true&&typeof this["on"+c]==="function")?this["on"+c]:null}if(e!==null&&this.views.hasOwnProperty(a)){this.getView(a).on(f,$.proxy(e,this))}else{if(e!==null&&this.elements.hasOwnProperty(a)){this.getElement(a).on(f,$.proxy(e,this))}}}}this.fire("_appear")},onAppear:function(){for(var a in this.views){this.views[a].show()}this.target.removeClass("hidden");this.fire("_appeared")},onDidAppear:function(){for(var b=0,a=this.showEvts.length;b<a;b++){this.showEvts[b].detach()}this.showEvts=[];this.appearing=false;this.visible=true;this.fire("appear")},hide:function(){if(!this.visible||this.disappearing){return}this.disappearing=true;this.hideEvts.push(this.on("_disappear",this.onDisappear,this));this.hideEvts.push(this.on("_disappeared",this.onDidDisappear,this));this.onWillDisappear()},onWillDisappear:function(){for(var a in this.views){this.getView(a).detach()}for(var b in this.elements){this.getElement(b).unbind()}this.fire("_disappear")},onDisappear:function(){this.target.addClass("hidden");for(var a in this.views){this.views[a].hide()}this.fire("_disappeared")},onDidDisappear:function(){for(var b=0,a=this.hideEvts.length;b<a;b++){this.hideEvts[b].detach()}this.hideEvts=[];this.disappearing=false;this.visible=false;this.fire("disappear")},getView:function(a){if(a instanceof ViewController){return a}else{if(typeof this.views[a]!=="undefined"){return this.views[a]}}throw'Error: View "'+a+'" not found'},getElement:function(a){if(typeof this.elements[a]!=="undefined"){return this.elements[a]}throw'Error: Element "'+a+'" not found'},hasView:function(a){return typeof this.views[a]!=="undefined"},hasElement:function(a){return typeof this.elements[a]!=="undefined"},setView:function(b,a){console.log(this);if(this.views.hasOwnProperty(b)){throw"View already exists"}this.views[b]=a},clearView:function(a){if(this.views.hasOwnProperty(a)){this.views[a].destroy();delete this.views[a]}},on:function(c,d,b){var a=(typeof b!=="undefined")?function(){d.apply(b,arguments)}:d;return this.eventTarget.on.call(this.eventTarget,c,a)},detach:function(a,b){return this.eventTarget.detach.apply(this.eventTarget,arguments)},fire:function(a,b){return this.eventTarget.fire.apply(this.eventTarget,arguments)},toString:function(){return"["+this.getType()+" "+this.data.name+"]"},find:function(a){return $(this.target).find(a)},destroy:function(){for(var a in this._views){this.views[a].destroy()}for(var a in this._elements){delete this.elements[a]}delete this.target;delete this.parent;delete this.eventTarget}});ViewController.views={view:ViewController};ViewController.prototype.typeList="";ViewController.extend=function(e){var b=Class.extend.call(this,e),d=e.getType();var f=["getType"];for(var c=0,a=f.length;c<a;c++){if(!e.hasOwnProperty(f[c])){throw"Class missing '"+f[c]+"()' implementation"}b[f[c]]=e[f[c]]}b.prototype.typeList+=((b.prototype.typeList=="")?"":" ")+d;b.extend=arguments.callee;return ViewController.views[d]=b};ViewController.get=function(a){if(a=="ui-view"){return this}if(!this.views.hasOwnProperty(a)){throw"View '"+a+'" not found'}return this.views[a]};View=(function(){var a={};var b=function(d){if(a.hasOwnProperty(d)){return a[d]}var c=$.ajax({async:false,contentType:"text/html; charset=utf-8",dataType:"text",timeout:10000,url:d,success:function(){},error:function(){throw"Error: template not found"}}).responseText;a[d]=c;return c};return{load:function(h,f,e){if(typeof h==="undefined"||h==""){return}var g=b(h),d,c;if($(g).length>1){d=$("<div>"+g+"</div>")}else{if(typeof f=="undefined"&&typeof e=="undefined"){return $(g)}}if(typeof f!=="undefined"&&typeof e!=="undefined"){c=d.find('[data-control="'+f+'"][data-name="'+e+'"]:last')}else{if(typeof f!=="undefined"){c=d.find('[data-control="'+f+'"]:last')}else{throw"View not found"}}if(c.length){return c}else{throw"View not found"}}}})();var Application=Class.extend({initialize:function(a){if(!a.hasOwnProperty("name")||(new RegExp(/[^A-Za-z:0-9_\[\]]/g)).test(a.name)){throw"Invalid application name"}this.config=a;window.onload=Class.proxy(this.onLoad,this)},onLoad:function(){var b=$("[data-root]"),e=b.attr("data-control"),d=b.attr("data-name");if(typeof e==="undefined"||typeof d==="undefined"){throw"Root view not found"}b.removeAttr("data-root");var f=ViewController.get(e);var a=new f(null,b);a.on("load",function(){a.show()});a.load()}});